{
  "rules": {
    ".read": "auth != null",
    ".write": "auth != null",
    
    "progress": {
      "$studentUid": {
        ".read": "auth != null && (auth.uid == $studentUid || root.child('users').child(auth.uid).child('role').val() == 'teacher')",
        ".write": "auth != null && (auth.uid == $studentUid || root.child('users').child(auth.uid).child('role').val() == 'teacher')",
        
        "$courseId": {
          ".validate": "newData.hasChildren(['lessonsCompleted', 'examsCompleted'])",
          "lessonsCompleted": {
            ".validate": "newData.isString() || newData.hasChildren()"
          },
          "examsCompleted": {
            ".validate": "newData.isString() || newData.hasChildren()"
          },
          "lastUpdated": {
            ".validate": "newData.isNumber()"
          }
        }
      }
    },
    
    "notifications": {
      ".read": "auth != null",
      ".write": "auth != null && root.child('users').child(auth.uid).child('role').val() == 'teacher'",
      
      "$notificationId": {
        ".validate": "newData.hasChildren(['title', 'timestamp'])",
        "title": {
          ".validate": "newData.isString() && newData.val().length > 0"
        },
        "courseId": {
          ".validate": "newData.isString() || !newData.exists()"
        },
        "message": {
          ".validate": "newData.isString() || !newData.exists()"
        },
        "type": {
          ".validate": "newData.isString() || !newData.exists()"
        },
        "timestamp": {
          ".validate": "newData.isNumber()"
        }
      }
    },
    
    "liveChat": {
      "$courseId": {
        ".read": "auth != null",
        ".write": "auth != null",
        
        "$messageId": {
          ".validate": "newData.hasChildren(['userId', 'userName', 'message', 'timestamp'])",
          "userId": {
            ".validate": "newData.isString() && newData.val() == auth.uid"
          },
          "userName": {
            ".validate": "newData.isString() && newData.val().length > 0"
          },
          "message": {
            ".validate": "newData.isString() && newData.val().length > 0 && newData.val().length <= 500"
          },
          "timestamp": {
            ".validate": "newData.isNumber()"
          }
        }
      }
    }
  }
}
