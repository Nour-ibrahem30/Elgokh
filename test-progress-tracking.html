<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ø§Ø®ØªØ¨Ø§Ø± Ù†Ø¸Ø§Ù… ØªØªØ¨Ø¹ Ø§Ù„ØªÙ‚Ø¯Ù…</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: 'Cairo', 'Segoe UI', sans-serif;
            background: linear-gradient(135deg, #0f172a 0%, #1e293b 100%);
            color: #f1f5f9;
            padding: 2rem;
            min-height: 100vh;
        }
        .container {
            max-width: 1000px;
            margin: 0 auto;
            background: rgba(30, 41, 59, 0.8);
            backdrop-filter: blur(15px);
            border: 2px solid rgba(59, 130, 246, 0.3);
            border-radius: 20px;
            padding: 2rem;
        }
        h1 {
            color: #3b82f6;
            margin-bottom: 2rem;
            text-align: center;
        }
        .section {
            background: rgba(15, 23, 42, 0.5);
            padding: 1.5rem;
            border-radius: 12px;
            margin-bottom: 1.5rem;
            border: 2px solid rgba(59, 130, 246, 0.2);
        }
        .section h2 {
            color: #60a5fa;
            margin-bottom: 1rem;
            font-size: 1.3rem;
        }
        .stat {
            display: flex;
            justify-content: space-between;
            padding: 0.75rem;
            background: rgba(30, 41, 59, 0.6);
            border-radius: 8px;
            margin-bottom: 0.5rem;
        }
        .stat-label {
            color: #94a3b8;
        }
        .stat-value {
            color: #3b82f6;
            font-weight: bold;
        }
        .btn {
            padding: 1rem 2rem;
            background: linear-gradient(135deg, #3b82f6, #8b5cf6);
            color: white;
            border: none;
            border-radius: 12px;
            cursor: pointer;
            font-size: 1rem;
            font-weight: 600;
            transition: all 0.3s ease;
            width: 100%;
            margin-top: 1rem;
        }
        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 30px rgba(59, 130, 246, 0.4);
        }
        .loading {
            text-align: center;
            padding: 2rem;
            color: #94a3b8;
        }
        .spinner {
            border: 4px solid rgba(59, 130, 246, 0.2);
            border-top: 4px solid #3b82f6;
            border-radius: 50%;
            width: 50px;
            height: 50px;
            animation: spin 1s linear infinite;
            margin: 0 auto 1rem;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        .success {
            background: rgba(16, 185, 129, 0.2);
            border-color: #10b981;
            color: #10b981;
            padding: 1rem;
            border-radius: 8px;
            margin-top: 1rem;
        }
        .error {
            background: rgba(239, 68, 68, 0.2);
            border-color: #ef4444;
            color: #ef4444;
            padding: 1rem;
            border-radius: 8px;
            margin-top: 1rem;
        }
        .log {
            background: rgba(15, 23, 42, 0.8);
            padding: 1rem;
            border-radius: 8px;
            margin-top: 1rem;
            font-family: 'Courier New', monospace;
            font-size: 0.9rem;
            max-height: 300px;
            overflow-y: auto;
        }
        .log-entry {
            padding: 0.25rem 0;
            border-bottom: 1px solid rgba(59, 130, 246, 0.1);
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸ§ª Ø§Ø®ØªØ¨Ø§Ø± Ù†Ø¸Ø§Ù… ØªØªØ¨Ø¹ Ø§Ù„ØªÙ‚Ø¯Ù…</h1>

        <div id="loadingState" class="loading">
            <div class="spinner"></div>
            <p>Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„...</p>
        </div>

        <div id="content" style="display: none;">
            <div class="section">
                <h2>ğŸ‘¤ Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…</h2>
                <div class="stat">
                    <span class="stat-label">Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ:</span>
                    <span class="stat-value" id="userEmail">-</span>
                </div>
                <div class="stat">
                    <span class="stat-label">Ù…Ø¹Ø±Ù Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…:</span>
                    <span class="stat-value" id="userId">-</span>
                </div>
            </div>

            <div class="section">
                <h2>ğŸ“Š Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª Ø§Ù„Ø­Ø§Ù„ÙŠØ©</h2>
                <div class="stat">
                    <span class="stat-label">Ø§Ù„ÙÙŠØ¯ÙŠÙˆÙ‡Ø§Øª Ø§Ù„Ù…Ø´Ø§Ù‡Ø¯Ø©:</span>
                    <span class="stat-value" id="watchedVideos">0</span>
                </div>
                <div class="stat">
                    <span class="stat-label">Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„ÙÙŠØ¯ÙŠÙˆÙ‡Ø§Øª:</span>
                    <span class="stat-value" id="totalVideos">0</span>
                </div>
                <div class="stat">
                    <span class="stat-label">Ø§Ù„Ø§Ù…ØªØ­Ø§Ù†Ø§Øª Ø§Ù„Ù†Ø§Ø¬Ø­Ø©:</span>
                    <span class="stat-value" id="passedExams">0</span>
                </div>
                <div class="stat">
                    <span class="stat-label">Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø§Ù…ØªØ­Ø§Ù†Ø§Øª:</span>
                    <span class="stat-value" id="totalExams">0</span>
                </div>
                <div class="stat">
                    <span class="stat-label">Ù†Ø³Ø¨Ø© Ø§Ù„ØªÙ‚Ø¯Ù… ÙÙŠ Ø§Ù„ÙÙŠØ¯ÙŠÙˆÙ‡Ø§Øª:</span>
                    <span class="stat-value" id="videoProgress">0%</span>
                </div>
                <div class="stat">
                    <span class="stat-label">Ù†Ø³Ø¨Ø© Ø§Ù„ØªÙ‚Ø¯Ù… ÙÙŠ Ø§Ù„Ø§Ù…ØªØ­Ø§Ù†Ø§Øª:</span>
                    <span class="stat-value" id="examProgress">0%</span>
                </div>
            </div>

            <div class="section">
                <h2>ğŸ§ª Ø§Ø®ØªØ¨Ø§Ø±Ø§Øª</h2>
                <button class="btn" onclick="testVideoWatch()">Ø§Ø®ØªØ¨Ø§Ø± ØªØ³Ø¬ÙŠÙ„ Ù…Ø´Ø§Ù‡Ø¯Ø© ÙÙŠØ¯ÙŠÙˆ</button>
                <button class="btn" onclick="testExamResult()">Ø§Ø®ØªØ¨Ø§Ø± Ø­ÙØ¸ Ù†ØªÙŠØ¬Ø© Ø§Ù…ØªØ­Ø§Ù†</button>
                <button class="btn" onclick="refreshStats()">ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª</button>
                <div id="testResult"></div>
            </div>

            <div class="section">
                <h2>ğŸ“ Ø³Ø¬Ù„ Ø§Ù„Ø£Ø­Ø¯Ø§Ø«</h2>
                <div class="log" id="logContainer"></div>
            </div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js';
        import { getAuth, onAuthStateChanged } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js';
        import { getFirestore, collection, query, where, getDocs, doc, setDoc, serverTimestamp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js';

        const firebaseConfig = {
            apiKey: "AIzaSyAU0CCiQNrPEYpTNU4rAwmOmPUZnjb2FoU",
            authDomain: "a-platform-for-learning.firebaseapp.com",
            projectId: "a-platform-for-learning",
            storageBucket: "a-platform-for-learning.firebasestorage.app",
            messagingSenderId: "764579707883",
            appId: "1:764579707883:web:5456e2348354cc58fab7ae"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        let currentUser = null;

        function log(message, type = 'info') {
            const logContainer = document.getElementById('logContainer');
            const entry = document.createElement('div');
            entry.className = 'log-entry';
            const timestamp = new Date().toLocaleTimeString('ar-EG');
            const icon = type === 'success' ? 'âœ…' : type === 'error' ? 'âŒ' : 'â„¹ï¸';
            entry.textContent = `[${timestamp}] ${icon} ${message}`;
            logContainer.insertBefore(entry, logContainer.firstChild);
            console.log(message);
        }

        async function loadStats() {
            if (!currentUser) return;

            try {
                log('Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª...');

                // Load total counts
                const videosSnapshot = await getDocs(collection(db, 'videos'));
                const examsSnapshot = await getDocs(collection(db, 'exams'));
                
                const totalVideos = videosSnapshot.size;
                const totalExams = examsSnapshot.size;

                // Load user's progress
                const videoWatchesQuery = query(
                    collection(db, 'videoWatches'),
                    where('userId', '==', currentUser.uid)
                );
                const videoWatchesSnapshot = await getDocs(videoWatchesQuery);
                const watchedVideos = videoWatchesSnapshot.size;

                const examResultsQuery = query(
                    collection(db, 'examResults'),
                    where('userId', '==', currentUser.uid),
                    where('passed', '==', true)
                );
                const examResultsSnapshot = await getDocs(examResultsQuery);
                const passedExams = examResultsSnapshot.size;

                // Update UI
                document.getElementById('watchedVideos').textContent = watchedVideos;
                document.getElementById('totalVideos').textContent = totalVideos;
                document.getElementById('passedExams').textContent = passedExams;
                document.getElementById('totalExams').textContent = totalExams;

                const videoProgress = totalVideos > 0 ? Math.round((watchedVideos / totalVideos) * 100) : 0;
                const examProgress = totalExams > 0 ? Math.round((passedExams / totalExams) * 100) : 0;

                document.getElementById('videoProgress').textContent = videoProgress + '%';
                document.getElementById('examProgress').textContent = examProgress + '%';

                log(`ØªÙ… ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª: ${watchedVideos}/${totalVideos} ÙÙŠØ¯ÙŠÙˆØŒ ${passedExams}/${totalExams} Ø§Ù…ØªØ­Ø§Ù†`, 'success');
            } catch (error) {
                log('Ø®Ø·Ø£ ÙÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª: ' + error.message, 'error');
                console.error(error);
            }
        }

        window.testVideoWatch = async function() {
            const resultDiv = document.getElementById('testResult');
            resultDiv.innerHTML = '<div class="loading"><div class="spinner"></div><p>Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø±...</p></div>';

            try {
                log('Ø§Ø®ØªØ¨Ø§Ø± ØªØ³Ø¬ÙŠÙ„ Ù…Ø´Ø§Ù‡Ø¯Ø© ÙÙŠØ¯ÙŠÙˆ...');

                const testVideoId = 'test_video_' + Date.now();
                const watchRef = doc(db, 'videoWatches', `${currentUser.uid}_${testVideoId}`);
                
                await setDoc(watchRef, {
                    userId: currentUser.uid,
                    videoId: testVideoId,
                    videoTitle: 'ÙÙŠØ¯ÙŠÙˆ ØªØ¬Ø±ÙŠØ¨ÙŠ',
                    watchedAt: serverTimestamp(),
                    completed: true,
                    duration: 10
                });

                resultDiv.innerHTML = '<div class="success">âœ… ØªÙ… ØªØ³Ø¬ÙŠÙ„ Ù…Ø´Ø§Ù‡Ø¯Ø© Ø§Ù„ÙÙŠØ¯ÙŠÙˆ Ø¨Ù†Ø¬Ø§Ø­!</div>';
                log('ØªÙ… ØªØ³Ø¬ÙŠÙ„ Ù…Ø´Ø§Ù‡Ø¯Ø© ÙÙŠØ¯ÙŠÙˆ ØªØ¬Ø±ÙŠØ¨ÙŠ', 'success');
                
                setTimeout(() => {
                    loadStats();
                }, 1000);
            } catch (error) {
                resultDiv.innerHTML = `<div class="error">âŒ Ø®Ø·Ø£: ${error.message}</div>`;
                log('Ø®Ø·Ø£ ÙÙŠ ØªØ³Ø¬ÙŠÙ„ Ù…Ø´Ø§Ù‡Ø¯Ø© Ø§Ù„ÙÙŠØ¯ÙŠÙˆ: ' + error.message, 'error');
                console.error(error);
            }
        };

        window.testExamResult = async function() {
            const resultDiv = document.getElementById('testResult');
            resultDiv.innerHTML = '<div class="loading"><div class="spinner"></div><p>Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø±...</p></div>';

            try {
                log('Ø§Ø®ØªØ¨Ø§Ø± Ø­ÙØ¸ Ù†ØªÙŠØ¬Ø© Ø§Ù…ØªØ­Ø§Ù†...');

                const testExamId = 'test_exam_' + Date.now();
                const resultRef = doc(db, 'examResults', `${currentUser.uid}_${testExamId}_${Date.now()}`);
                
                await setDoc(resultRef, {
                    userId: currentUser.uid,
                    examId: testExamId,
                    examTitle: 'Ø§Ù…ØªØ­Ø§Ù† ØªØ¬Ø±ÙŠØ¨ÙŠ',
                    score: 85,
                    correctAnswers: 17,
                    incorrectAnswers: 3,
                    totalQuestions: 20,
                    passed: true,
                    completedAt: new Date().toISOString(),
                    timeSpent: 600,
                    answers: { 0: 1, 1: 2, 2: 0 }
                });

                resultDiv.innerHTML = '<div class="success">âœ… ØªÙ… Ø­ÙØ¸ Ù†ØªÙŠØ¬Ø© Ø§Ù„Ø§Ù…ØªØ­Ø§Ù† Ø¨Ù†Ø¬Ø§Ø­!</div>';
                log('ØªÙ… Ø­ÙØ¸ Ù†ØªÙŠØ¬Ø© Ø§Ù…ØªØ­Ø§Ù† ØªØ¬Ø±ÙŠØ¨ÙŠ (85%)', 'success');
                
                setTimeout(() => {
                    loadStats();
                }, 1000);
            } catch (error) {
                resultDiv.innerHTML = `<div class="error">âŒ Ø®Ø·Ø£: ${error.message}</div>`;
                log('Ø®Ø·Ø£ ÙÙŠ Ø­ÙØ¸ Ù†ØªÙŠØ¬Ø© Ø§Ù„Ø§Ù…ØªØ­Ø§Ù†: ' + error.message, 'error');
                console.error(error);
            }
        };

        window.refreshStats = function() {
            loadStats();
        };

        onAuthStateChanged(auth, (user) => {
            if (user) {
                currentUser = user;
                document.getElementById('userEmail').textContent = user.email;
                document.getElementById('userId').textContent = user.uid;
                document.getElementById('loadingState').style.display = 'none';
                document.getElementById('content').style.display = 'block';
                log('ØªÙ… ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„: ' + user.email, 'success');
                loadStats();
            } else {
                // Check localStorage
                const storedEmail = localStorage.getItem('currentUserEmail');
                if (storedEmail) {
                    currentUser = { uid: 'local-' + storedEmail.split('@')[0], email: storedEmail };
                    document.getElementById('userEmail').textContent = storedEmail;
                    document.getElementById('userId').textContent = currentUser.uid;
                    document.getElementById('loadingState').style.display = 'none';
                    document.getElementById('content').style.display = 'block';
                    log('ØªÙ… ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ (localStorage): ' + storedEmail, 'success');
                    loadStats();
                } else {
                    alert('ÙŠØ¬Ø¨ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ø£ÙˆÙ„Ø§Ù‹');
                    window.location.href = 'public/pages/login.html';
                }
            }
        });
    </script>
</body>
</html>
